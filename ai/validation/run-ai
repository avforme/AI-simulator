#!/bin/bash

AIPLANNER_HOME=${AIPLANNER_HOME:-$HOME/aiplanner}
PARALLEL=${PARALLEL:-True}  # Set to "False" to run seeds sequentially rather than in parallel.
SEEDS=${SEEDS:-5}
EVAL_TIMESTEPS=${EVAL_TIMESTEPS:-4000000}

AI_DIR=$AIPLANNER_HOME/ai
export PYTHONPATH=$AI_DIR/baselines:$AI_DIR/gym-fin

if [ "$PARALLEL" = False ]; then
    VALIDATE=validate
else
    VALIDATE=validate_parallel
fi

validate () {

    MODEL_NAME=$1
    ARGS=$2
    TRAIN_ARGS=$3
    EVAL_ARGS=$4

    SEED=0
    while [ $SEED -lt $SEEDS ]; do
        MODEL_DIR=run.$MODEL_NAME-seed_$SEED.tf
        TEMPFILE=`tempfile -p valid`
        $AI_DIR/train_ppo1.py --model-dir=$MODEL_DIR $ARGS --train-seed=$SEED $TRAIN_ARGS 2>&1 >> $TEMPFILE
        mv $TEMPFILE $MODEL_DIR/train.out
        $AI_DIR/run_model.py --model-dir=$MODEL_DIR $ARGS --eval-num-timesteps=$EVAL_TIMESTEPS $EVAL_ARGS 2>&1 >> $MODEL_DIR/eval.out
        SEED=`expr $SEED + 1`
    done
}

validate_parallel () {

    MODEL_NAME=$1
    ARGS=$2
    TRAIN_ARGS=$3
    EVAL_ARGS=$4

    SEED=0
    while [ $SEED -lt $SEEDS ]; do
        MODEL_DIR=run.$MODEL_NAME-seed_$SEED.tf
        # Output directory must not exist when tensorflow save() is called to save the model hence we can't write the log within it; instead log to a tempfile.
        TEMPFILE=`tempfile -p valid`
        TEMPFILES[$SEED]=$TEMPFILE
        $AI_DIR/train_ppo1.py --model-dir=$MODEL_DIR $ARGS --train-seed=$SEED $TRAIN_ARGS >> $TEMPFILE 2>&1 &
        SEED=`expr $SEED + 1`
    done
    wait

    SEED=0
    while [ $SEED -lt $SEEDS ]; do
        MODEL_DIR=run.$MODEL_NAME-seed_$SEED.tf
        mv ${TEMPFILES[$SEED]} $MODEL_DIR/train.log
        $AI_DIR/run_model.py --model-dir=$MODEL_DIR $ARGS --eval-num-timesteps=$EVAL_TIMESTEPS $EVAL_ARGS >> $MODEL_DIR/eval.log 2>&1 &
        SEED=`expr $SEED + 1`
    done
    wait
}

$VALIDATE fixed_30-gi_0-p_2000000 '--master-guaranteed-income=0 --master-p-notax=2000000'
$VALIDATE fixed_30-gi_16000-p_2000000 '--master-guaranteed-income=16000 --master-p-notax=2000000'
$VALIDATE fixed_30-gi_16000-p_2000000-timesteps_4000000 '--master-guaranteed-income=16000 --master-p-notax=2000000' '--train-num-timesteps=4000000'
