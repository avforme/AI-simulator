#!/bin/bash

# AIPlanner - Deep Learning Financial Planner
# Copyright (C) 2018 Gordon Irlam
#
# All rights reserved. This program may not be used, copied, modified,
# or redistributed without permission.
#
# This program is distributed WITHOUT ANY WARRANTY; without even the
# implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
# PURPOSE.

AIPLANNER_HOME=${AIPLANNER_HOME:-$HOME/aiplanner}

source $AIPLANNER_HOME/ai/helpers.bash

mkdir -p ~/aiplanner-data/models.new
cd ~/aiplanner-data/models.new

PARALLEL=Jobs

SPIAS_TYPE=real
SAVESTEPS=2000000

TRAINING=generic
UNIT=single
GAMMAS="1.5 3 6"

for STAGE in preretirement retired; do
    for SPIAS in none $SPIAS_TYPE; do
        for GAMMA in $GAMMAS; do
            TIMESTEPS=`timesteps $TRAINING $UNIT $STAGE $SPIAS $GAMMA`
            ARGS="--train-num-timesteps=$TIMESTEPS --train-save-frequency=$SAVESTEPS"
            train_scenarios $TRAINING $UNIT $STAGE $SPIAS $GAMMA "$ARGS"
        done
    done
done
wait

start_ray_if_needed
TEMPFILE=`tempfile -p train`
for MODEL_DIR in aiplanner-*.tf; do
    $AI_DIR/export_model.py --redis-address=$RAY_REDIS_ADDRESS --model-dir=$MODEL_DIR --train-seed=$SEED_START --train-seeds=$SEEDS >> $TEMPFILE 2>&1 &
done
wait

cp $BASE_SCENARIO ./base-scenario.txt
ln -s $AI_DIR/market-data.txt ./
